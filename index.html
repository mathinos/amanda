<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cinema Reservation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .event {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .reserve-button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .reserve-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Upcoming Screenings</h1>
  <div id="event-list">Loading events...</div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCA4sz-eVQrNz2g2GSMlXM53Yva6UbT23qSrM-CwCZuFKDOXCvn2v86dwXLnOC_KNEKs3qqhc_JdhA/pub?output=csv";
    const scriptWebAppUrl = "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE";

    function isFutureDate(dateStr, timeStr) {
      const fullDateTime = `${dateStr.trim()} ${timeStr.trim()}`;
      const showDate = new Date(fullDateTime);
      return !isNaN(showDate.getTime()) && showDate > new Date();
    }

    async function fetchEvents() {
      const response = await fetch(csvUrl);
      const data = await response.text();
      const rows = data.split("\n").slice(1);

      const eventList = document.getElementById("event-list");
      eventList.innerHTML = "";

      rows.forEach(row => {
        const columns = row.split(",");
        if (columns.length >= 3) {
          const [date, time, title, seats, notes] = columns;
          const availableSeats = parseInt(seats);

          if (!isNaN(availableSeats) && isFutureDate(date, time)) {
            const eventEl = document.createElement("div");
            eventEl.className = "event";

            const formattedLine = `ðŸŽ¬ ${date.trim()} - ${time.trim()}`;

            eventEl.innerHTML = `
              <p class="formatted">${formattedLine}</p>
              <p><strong>Movie:</strong> ${title}</p>
              <p><strong>Available Seats:</strong> ${availableSeats}</p>
              ${notes ? `<p><strong>Notes:</strong> ${notes.trim()}</p>` : ""}
              <button class="reserve-button">Reserve Now</button>
            `;

            eventEl.querySelector(".reserve-button").addEventListener("click", () => {
              const tickets = prompt(`How many tickets would you like to reserve? (Available: ${availableSeats})`, "1");
              const ticketsInt = parseInt(tickets);
              if (isNaN(ticketsInt) || ticketsInt < 1 || ticketsInt > availableSeats) {
                alert("Invalid number of tickets selected.");
                return;
              }

              const name = prompt("Enter your name:");
              const surname = prompt("Enter your surname:");
              const phone = prompt("Enter your phone number:");
              const email = prompt("Enter your email:");

              const reservationData = {
                date: date.trim(),
                time: time.trim(),
                title: title.trim(),
                tickets: ticketsInt,
                name: name.trim(),
                surname: surname.trim(),
                phone: phone.trim(),
                email: email.trim(),
              };

              fetch(scriptWebAppUrl, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(reservationData)
              })
              .then(res => res.json())
              .then(result => {
                if (result.success) {
                  alert("Reservation successful!");
                  fetchEvents(); // Refresh events list
                } else {
                  alert("Reservation failed: " + result.message);
                }
              })
              .catch(err => {
                alert("Error submitting reservation: " + err);
              });
            });

            eventList.appendChild(eventEl);
          }
        }
      });
    }

    fetchEvents();
</script>

<div id="event-list"></div>

</body>
</html>
