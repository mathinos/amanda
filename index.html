<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cinema Reservation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .event {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .reserve-button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .reserve-button:disabled {
      background-color: #aaa;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Upcoming Screenings</h1>
  <div id="event-list">Loading events...</div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCA4sz-eVQrNz2g2GSMlXM53Yva6UbT23qSrM-CwCZuFKDOXCvn2v86dwXLnOC_KNEKs3qqhc_JdhA/pub?output=csv";

    function isFutureDate(dateStr, timeStr) {
      const fullDateTime = `${dateStr.trim()} ${timeStr.trim()}`;
      const showDate = new Date(fullDateTime);
      return !isNaN(showDate.getTime()) && showDate > new Date();
    }

    async function fetchEvents() {
      const response = await fetch(csvUrl);
      const data = await response.text();
      const rows = data.split("\n").slice(1);

      const eventList = document.getElementById("event-list");
      eventList.innerHTML = "";

      rows.forEach(row => {
        const columns = row.split(",");
        if (columns.length >= 4) {
          const [date, time, title, seats] = columns;
          const availableSeats = parseInt(seats);
          if (!isNaN(availableSeats) && isFutureDate(date, time)) {
            const eventEl = document.createElement("div");
            eventEl.className = "event";

            eventEl.innerHTML = `
              <p><strong>Date:</strong> ${date.trim()} ${time.trim()}</p>
              <p><strong>Movie:</strong> ${title.trim()}</p>
              <p><strong>Available Seats:</strong> <span id="seats-${date.trim()}-${time.trim()}">${availableSeats}</span></p>
              <button class="reserve-button" onclick="openReservationForm('${title.trim()}', '${date.trim()}', '${time.trim()}', ${availableSeats})">Reserve Now</button>
            `;

            eventList.appendChild(eventEl);
          }
        }
      });
    }

    function openReservationForm(title, date, time, maxSeats) {
      const name = prompt("Your Name:");
      const surname = prompt("Your Surname:");
      const phone = prompt("Phone:");
      const email = prompt("Email:");
      const requested = parseInt(prompt(`How many tickets? (Max: ${maxSeats})`));
      if (requested > maxSeats) {
        alert("Not enough seats available.");
        return;
      }

      const formData = new FormData();
      formData.append("title", title);
      formData.append("date", date);
      formData.append("time", time);
      formData.append("name", name);
      formData.append("surname", surname);
      formData.append("phone", phone);
      formData.append("email", email);
      formData.append("tickets", requested);

      fetch("https://script.google.com/macros/s/AKfycbxniEVAhktwcPx7iIAZIAIXaoPDYnEGZPFHdiMrji53-d5ulM_JsWC6uyKLPsvH4Y8l/exec", {
        method: "POST",
        body: formData
      })
      .then(response => response.text())
      .then(result => {
        alert(result);
        fetchEvents(); // reload seats
      })
      .catch(err => alert("Reservation failed."));
    }

    fetchEvents();
  </script>
</body>
</html>
